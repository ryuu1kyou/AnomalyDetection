# CANç•°å¸¸æ¤œå‡ºç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - Alertmanagerè¨­å®š

global:
  smtp_smarthost: '${SMTP_HOST}:${SMTP_PORT}'
  smtp_from: '${ALERT_EMAIL_FROM}'
  smtp_auth_username: '${SMTP_USERNAME}'
  smtp_auth_password: '${SMTP_PASSWORD}'
  slack_api_url: '${SLACK_WEBHOOK_URL}'

# ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®š
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'default'
  routes:
    # é‡è¦åº¦åˆ¥ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 5s
      repeat_interval: 30m
    
    - match:
        severity: warning
      receiver: 'warning-alerts'
      repeat_interval: 2h
    
    - match:
        severity: info
      receiver: 'info-alerts'
      repeat_interval: 12h
    
    # ã‚µãƒ¼ãƒ“ã‚¹åˆ¥ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
    - match:
        service: database
      receiver: 'database-alerts'
      group_wait: 5s
    
    - match:
        service: security
      receiver: 'security-alerts'
      group_wait: 0s
      repeat_interval: 15m
    
    # ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹
    - match:
        service: business
      receiver: 'business-alerts'
      repeat_interval: 4h

# å—ä¿¡è€…è¨­å®š
receivers:
  - name: 'default'
    slack_configs:
      - channel: '#alerts'
        title: 'CANç•°å¸¸æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ  ã‚¢ãƒ©ãƒ¼ãƒˆ'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          *Service:* {{ .Labels.service }}
          {{ end }}

  - name: 'critical-alerts'
    email_configs:
      - to: '${CRITICAL_ALERT_EMAIL}'
        subject: 'ğŸš¨ CRITICAL: CANç•°å¸¸æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ '
        body: |
          é‡è¦ãªã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
          
          {{ range .Alerts }}
          ã‚¢ãƒ©ãƒ¼ãƒˆ: {{ .Annotations.summary }}
          è©³ç´°: {{ .Annotations.description }}
          é‡è¦åº¦: {{ .Labels.severity }}
          ã‚µãƒ¼ãƒ“ã‚¹: {{ .Labels.service }}
          æ™‚åˆ»: {{ .StartsAt }}
          {{ end }}
    
    slack_configs:
      - channel: '#critical-alerts'
        color: 'danger'
        title: 'ğŸš¨ CRITICAL ALERT'
        text: |
          {{ range .Alerts }}
          *{{ .Annotations.summary }}*
          {{ .Annotations.description }}
          *Service:* {{ .Labels.service }}
          {{ end }}
    
    # SMSé€šçŸ¥ï¼ˆWebhookçµŒç”±ï¼‰
    webhook_configs:
      - url: '${SMS_WEBHOOK_URL}'
        send_resolved: false

  - name: 'warning-alerts'
    slack_configs:
      - channel: '#warnings'
        color: 'warning'
        title: 'âš ï¸ Warning Alert'
        text: |
          {{ range .Alerts }}
          *{{ .Annotations.summary }}*
          {{ .Annotations.description }}
          *Service:* {{ .Labels.service }}
          {{ end }}

  - name: 'info-alerts'
    slack_configs:
      - channel: '#info'
        color: 'good'
        title: 'â„¹ï¸ Info Alert'
        text: |
          {{ range .Alerts }}
          *{{ .Annotations.summary }}*
          {{ .Annotations.description }}
          {{ end }}

  - name: 'database-alerts'
    email_configs:
      - to: '${DBA_EMAIL}'
        subject: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ©ãƒ¼ãƒˆ - CANç•°å¸¸æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ '
        body: |
          ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢é€£ã®ã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
          
          {{ range .Alerts }}
          ã‚¢ãƒ©ãƒ¼ãƒˆ: {{ .Annotations.summary }}
          è©³ç´°: {{ .Annotations.description }}
          æ™‚åˆ»: {{ .StartsAt }}
          {{ end }}
    
    slack_configs:
      - channel: '#database'
        color: 'danger'
        title: 'ğŸ—„ï¸ Database Alert'
        text: |
          {{ range .Alerts }}
          *{{ .Annotations.summary }}*
          {{ .Annotations.description }}
          {{ end }}

  - name: 'security-alerts'
    email_configs:
      - to: '${SECURITY_TEAM_EMAIL}'
        subject: 'ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆ - CANç•°å¸¸æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ '
        body: |
          ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®ã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å³åº§ã«å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚
          
          {{ range .Alerts }}
          ã‚¢ãƒ©ãƒ¼ãƒˆ: {{ .Annotations.summary }}
          è©³ç´°: {{ .Annotations.description }}
          æ™‚åˆ»: {{ .StartsAt }}
          {{ end }}
    
    slack_configs:
      - channel: '#security'
        color: 'danger'
        title: 'ğŸ”’ SECURITY ALERT'
        text: |
          {{ range .Alerts }}
          *{{ .Annotations.summary }}*
          {{ .Annotations.description }}
          *IMMEDIATE ACTION REQUIRED*
          {{ end }}

  - name: 'business-alerts'
    slack_configs:
      - channel: '#business-metrics'
        color: 'warning'
        title: 'ğŸ“Š Business Metrics Alert'
        text: |
          {{ range .Alerts }}
          *{{ .Annotations.summary }}*
          {{ .Annotations.description }}
          {{ end }}

# æŠ‘åˆ¶ãƒ«ãƒ¼ãƒ«
inhibit_rules:
  # åŒã˜ã‚µãƒ¼ãƒ“ã‚¹ã®é‡è¦åº¦ã®ä½ã„ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ‘åˆ¶
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['service', 'instance']
  
  - source_match:
      severity: 'warning'
    target_match:
      severity: 'info'
    equal: ['service', 'instance']
  
  # ã‚³ãƒ³ãƒ†ãƒŠãƒ€ã‚¦ãƒ³æ™‚ã¯ä»–ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ‘åˆ¶
  - source_match:
      alertname: 'ContainerDown'
    target_match_re:
      alertname: '(HighResponseTime|HighErrorRate|DatabaseConnectionFailure)'
    equal: ['instance']