# CAN異常検出管理システム - Alertmanager設定

global:
  smtp_smarthost: '${SMTP_HOST}:${SMTP_PORT}'
  smtp_from: '${ALERT_EMAIL_FROM}'
  smtp_auth_username: '${SMTP_USERNAME}'
  smtp_auth_password: '${SMTP_PASSWORD}'
  slack_api_url: '${SLACK_WEBHOOK_URL}'

# テンプレート
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# ルーティング設定
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'default'
  routes:
    # 重要度別ルーティング
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 5s
      repeat_interval: 30m
    
    - match:
        severity: warning
      receiver: 'warning-alerts'
      repeat_interval: 2h
    
    - match:
        severity: info
      receiver: 'info-alerts'
      repeat_interval: 12h
    
    # サービス別ルーティング
    - match:
        service: database
      receiver: 'database-alerts'
      group_wait: 5s
    
    - match:
        service: security
      receiver: 'security-alerts'
      group_wait: 0s
      repeat_interval: 15m
    
    # ビジネスメトリクス
    - match:
        service: business
      receiver: 'business-alerts'
      repeat_interval: 4h

# 受信者設定
receivers:
  - name: 'default'
    slack_configs:
      - channel: '#alerts'
        title: 'CAN異常検出システム アラート'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          *Service:* {{ .Labels.service }}
          {{ end }}

  - name: 'critical-alerts'
    email_configs:
      - to: '${CRITICAL_ALERT_EMAIL}'
        subject: '🚨 CRITICAL: CAN異常検出システム'
        body: |
          重要なアラートが発生しました。
          
          {{ range .Alerts }}
          アラート: {{ .Annotations.summary }}
          詳細: {{ .Annotations.description }}
          重要度: {{ .Labels.severity }}
          サービス: {{ .Labels.service }}
          時刻: {{ .StartsAt }}
          {{ end }}
    
    slack_configs:
      - channel: '#critical-alerts'
        color: 'danger'
        title: '🚨 CRITICAL ALERT'
        text: |
          {{ range .Alerts }}
          *{{ .Annotations.summary }}*
          {{ .Annotations.description }}
          *Service:* {{ .Labels.service }}
          {{ end }}
    
    # SMS通知（Webhook経由）
    webhook_configs:
      - url: '${SMS_WEBHOOK_URL}'
        send_resolved: false

  - name: 'warning-alerts'
    slack_configs:
      - channel: '#warnings'
        color: 'warning'
        title: '⚠️ Warning Alert'
        text: |
          {{ range .Alerts }}
          *{{ .Annotations.summary }}*
          {{ .Annotations.description }}
          *Service:* {{ .Labels.service }}
          {{ end }}

  - name: 'info-alerts'
    slack_configs:
      - channel: '#info'
        color: 'good'
        title: 'ℹ️ Info Alert'
        text: |
          {{ range .Alerts }}
          *{{ .Annotations.summary }}*
          {{ .Annotations.description }}
          {{ end }}

  - name: 'database-alerts'
    email_configs:
      - to: '${DBA_EMAIL}'
        subject: 'データベースアラート - CAN異常検出システム'
        body: |
          データベース関連のアラートが発生しました。
          
          {{ range .Alerts }}
          アラート: {{ .Annotations.summary }}
          詳細: {{ .Annotations.description }}
          時刻: {{ .StartsAt }}
          {{ end }}
    
    slack_configs:
      - channel: '#database'
        color: 'danger'
        title: '🗄️ Database Alert'
        text: |
          {{ range .Alerts }}
          *{{ .Annotations.summary }}*
          {{ .Annotations.description }}
          {{ end }}

  - name: 'security-alerts'
    email_configs:
      - to: '${SECURITY_TEAM_EMAIL}'
        subject: '🔒 セキュリティアラート - CAN異常検出システム'
        body: |
          セキュリティ関連のアラートが発生しました。即座に対応が必要です。
          
          {{ range .Alerts }}
          アラート: {{ .Annotations.summary }}
          詳細: {{ .Annotations.description }}
          時刻: {{ .StartsAt }}
          {{ end }}
    
    slack_configs:
      - channel: '#security'
        color: 'danger'
        title: '🔒 SECURITY ALERT'
        text: |
          {{ range .Alerts }}
          *{{ .Annotations.summary }}*
          {{ .Annotations.description }}
          *IMMEDIATE ACTION REQUIRED*
          {{ end }}

  - name: 'business-alerts'
    slack_configs:
      - channel: '#business-metrics'
        color: 'warning'
        title: '📊 Business Metrics Alert'
        text: |
          {{ range .Alerts }}
          *{{ .Annotations.summary }}*
          {{ .Annotations.description }}
          {{ end }}

# 抑制ルール
inhibit_rules:
  # 同じサービスの重要度の低いアラートを抑制
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['service', 'instance']
  
  - source_match:
      severity: 'warning'
    target_match:
      severity: 'info'
    equal: ['service', 'instance']
  
  # コンテナダウン時は他のアラートを抑制
  - source_match:
      alertname: 'ContainerDown'
    target_match_re:
      alertname: '(HighResponseTime|HighErrorRate|DatabaseConnectionFailure)'
    equal: ['instance']