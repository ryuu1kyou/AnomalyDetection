# 要求仕様書: CAN 異常検出管理システム

## 1. はじめに

本ドキュメントは、CAN 異常検出管理システムの要求仕様を定義するものです。

### 1.1 目的
自動車業界におけるCAN信号の異常検出ロジックを開発・管理・共有するための、マルチテナント対応Webアプリケーションを開発する。

### 1.2 用語定義
- **OEM**: Original Equipment Manufacturer（自動車メーカー）
- **テナント**: システム内の独立したデータ空間を持つOEM組織
- **CAN信号**: Controller Area Network通信で使用される信号
- **検出ロジック**: CAN信号の異常を検出するためのアルゴリズムまたはルール
- **Value Object**: 識別子を持たず、属性値によって等価性が判断されるオブジェクト
- **Entity**: 一意の識別子を持ち、ライフサイクルを通じて追跡されるオブジェクト
- **Aggregate Root**: 関連するエンティティ群の整合性を保証する親エンティティ

## 2. 機能要件 (Functional Requirements)

### Req 1: マルチテナント管理

**ユーザーストーリー:** 
OEM管理者として、組織のテナント設定を管理し、データの隔離と共有リソースへのアクセス制御を維持したい。

**受け入れ基準:**
1. OEM管理者が新しいテナントを作成すると、システムは一意のテナント識別子を持つ隔離されたデータ空間を作成すること
2. テナント設定時、システムはOEMコード、企業名、国、連絡先情報の指定を許可すること
3. テナントがデータにアクセスする際、システムはデータ隔離を強制し、テナントが自身のデータと明示的に共有されたリソースのみにアクセスできることを保証すること
4. テナントがカスタム機能を持つ場合、システムは機能設定をキーバリューペアとして保存すること
5. テナントが無効化された場合、システムはデータの整合性を保持しながらテナントデータへのアクセスを防止すること

### Req 2: CAN信号管理

**ユーザーストーリー:** 
信号エンジニアとして、CAN信号仕様を定義・管理し、異常検出のための正確な信号定義を維持したい。

**受け入れ基準:**
1. 信号エンジニアがCAN信号を作成すると、システムは信号名、CAN ID、開始ビット、長さ、データ型を要求すること
2. CAN信号が定義されると、システムは信号識別子（名前とCAN ID）をValue Objectとして保存すること
3. 信号仕様が設定されると、システムは仕様詳細（開始ビット、長さ、データ型、バイトオーダー、値範囲）をValue Objectとして保存すること
4. 物理値変換が必要な場合、システムは変換パラメータ（係数、オフセット、単位）をValue Objectとして保存すること
5. 信号タイミングが設定されると、システムはタイミング情報（サイクル時間、タイムアウト、送信タイプ）をValue Objectとして保存すること
6. 信号バージョンが更新されると、システムはメジャーおよびマイナーバージョン番号でバージョン履歴を追跡すること
7. 信号がシステムカテゴリに属する場合、システムは信号を適切なシステムタイプに関連付けること

### Req 3: 異常検出ロジック管理

**ユーザーストーリー:** 
検出エンジニアとして、異常検出ロジックを作成・管理し、効果的な異常検出アルゴリズムを実装したい。

**受け入れ基準:**
1. 検出エンジニアが検出ロジックを作成すると、システムはロジック識別情報（名前、バージョン、OEMコード）をValue Objectとして要求すること
2. 検出ロジックが指定されると、システムは仕様詳細（検出タイプ、説明、対象システム、複雑度）をValue Objectとして保存すること
3. ロジック実装が提供されると、システムは実装詳細（タイプ、コンテンツ、言語、エントリポイント）をValue Objectとして保存すること
4. 安全性分類が必要な場合、システムは安全性情報（ASILレベル、安全要件ID、安全目標ID）をValue Objectとして保存すること
5. 検出パラメータが定義されると、システムは名前、データ型、値、制約、説明を持つパラメータエンティティを作成すること
6. CAN信号が検出ロジックにマッピングされると、システムは信号ID、ロール、設定を持つ信号マッピングエンティティを作成すること
7. 検出ロジックのステータスが変更されると、システムはステータス遷移（ドラフト、テスト中、承認済み、非推奨）を追跡すること
8. 共有レベルが設定されると、システムは可視性（プライベート、OEM共有、業界共有）を制御すること

### Req 4: 検出パラメータ管理

**ユーザーストーリー:** 
検出エンジニアとして、検証制約付きの検出パラメータを設定し、パラメータ値が許容範囲内にあることを確認したい。

**受け入れ基準:**
1. パラメータが作成されると、システムはパラメータを一意の識別子を持つエンティティとして保存すること
2. パラメータ制約が定義されると、システムは制約（最小/最大値、最小/最大長、パターン、許可値）をValue Objectとして保存すること
3. パラメータ値が更新されると、システムは定義された制約に対して値を検証すること
4. パラメータが必須の場合、システムは値が提供されなければならないことを強制すること
5. パラメータがデフォルト値を持つ場合、システムは値が指定されていない場合にデフォルトを使用すること

### Req 5: CAN信号マッピング管理

**ユーザーストーリー:** 
検出エンジニアとして、特定のロールで検出ロジックにCAN信号をマッピングし、検出に使用される信号を定義したい。

**受け入れ基準:**
1. 信号マッピングが作成されると、システムはマッピングを信号IDとロールを持つエンティティとして保存すること
2. マッピング設定が定義されると、システムは設定（スケーリング係数、オフセット、フィルタ式）をValue Objectとして保存すること
3. 信号が必須としてマークされると、システムは検出実行のために信号が存在しなければならないことを強制すること
4. 複数の信号がマッピングされると、システムは検出ロジック集約内でマッピングのコレクションを維持すること

### Req 6: プロジェクト管理

**ユーザーストーリー:** 
プロジェクトマネージャーとして、マイルストーンとチームメンバーを持つ異常検出プロジェクトを管理し、プロジェクトの進捗を追跡してチーム活動を調整したい。

**受け入れ基準:**
1. プロジェクトが作成されると、システムはプロジェクトコード、名前、車両モデル、モデル年、主要システムを要求すること
2. プロジェクト設定が設定されると、システムは設定（優先度、機密性、タグ、カスタム設定）をValue Objectとして保存すること
3. プロジェクトマイルストーンが定義されると、システムは名前、期限、ステータス、設定を持つマイルストーンエンティティを作成すること
4. チームメンバーが割り当てられると、システムはユーザーID、ロール、設定を持つメンバーエンティティを作成すること
5. プロジェクトステータスが変更されると、システムはステータス遷移（計画中、アクティブ、保留中、完了、キャンセル）を追跡すること

### Req 7: マイルストーン管理

**ユーザーストーリー:** 
プロジェクトマネージャーとして、依存関係を持つプロジェクトマイルストーンを定義し、プロジェクトフェーズを計画・追跡したい。

**受け入れ基準:**
1. マイルストーンが作成されると、システムはマイルストーンを名前と期限を持つエンティティとして保存すること
2. マイルストーン設定が定義されると、システムは設定（クリティカルフラグ、承認要件、依存関係）をValue Objectとして保存すること
3. マイルストーンが完了すると、システムは完了日と完了ユーザーを記録すること
4. マイルストーン依存関係が存在する場合、システムはマイルストーン間の依存関係を追跡すること
5. マイルストーンステータスが変更されると、システムはステータス遷移（保留中、進行中、完了、キャンセル）を追跡すること

### Req 8: プロジェクトメンバー管理

**ユーザーストーリー:** 
プロジェクトマネージャーとして、ロールと権限を持つプロジェクトチームメンバーを管理し、アクセスと責任を制御したい。

**受け入れ基準:**
1. メンバーがプロジェクトに追加されると、システムはメンバーをユーザーIDとロールを持つエンティティとして保存すること
2. メンバー設定が定義されると、システムは設定（権限、設定、通知設定）をValue Objectとして保存すること
3. メンバーがプロジェクトに参加すると、システムは参加日を記録すること
4. メンバーがプロジェクトを離れると、システムは離脱日を記録してメンバーを非アクティブとしてマークすること
5. メンバー権限が設定されると、システムは設定された権限に基づいてアクセス制御を強制すること

### Req 9: 異常検出結果管理

**ユーザーストーリー:** 
テストエンジニアとして、異常検出結果を記録・分析し、検出ロジックの有効性を評価したい。

**受け入れ基準:**
1. 検出が実行されると、システムは検出ロジックID、信号ID、タイムスタンプを持つ検出結果エンティティを作成すること
2. 入力データが記録されると、システムは入力データ（信号値、タイムスタンプ、追加データ）をValue Objectとして保存すること
3. 検出詳細が取得されると、システムは詳細（検出タイプ、トリガー条件、実行時間、パラメータ）をValue Objectとして保存すること
4. 異常レベルが決定されると、システムは重大度レベル（情報、警告、エラー、クリティカル）を記録すること
5. 確信度スコアが計算されると、システムは確信度スコア（0.0〜1.0）を保存すること
6. 解決ステータスが変更されると、システムはステータス遷移（未解決、調査中、解決済み、誤検知）を追跡すること

### Req 10: システムカテゴリ管理

**ユーザーストーリー:** 
システム管理者として、設定を持つCANシステムカテゴリを定義し、自動車システムごとに信号を整理したい。

**受け入れ基準:**
1. システムカテゴリが作成されると、システムはシステムタイプと名前を要求すること
2. カテゴリ設定が定義されると、システムは設定（優先度、安全関連性、リアルタイム監視要件）をValue Objectとして保存すること
3. カスタム設定が必要な場合、システムはカスタム設定をキーバリューペアとして保存すること
4. カテゴリがアクティブ化または非アクティブ化されると、システムはカテゴリの可用性を制御すること
5. 表示順序が設定されると、システムはUI表示にその順序を使用すること

### Req 11: OEMカスタマイズ管理

**ユーザーストーリー:** 
OEMエンジニアとして、組織用に共有検出ロジックと信号をカスタマイズし、業界標準を特定の要件に適応させたい。

**受け入れ基準:**
1. OEMがエンティティをカスタマイズすると、システムはエンティティID、エンティティタイプ、OEMコードを記録すること
2. カスタマイズパラメータが定義されると、システムはカスタムパラメータと元のパラメータの両方を保存すること
3. カスタマイズが作成されると、システムはカスタマイズ理由を要求してステータスをドラフトに設定すること
4. カスタマイズが承認のために提出されると、システムはステータスを承認待ちに変更すること
5. カスタマイズが承認されると、システムは承認者ID、承認日、承認メモを記録すること
6. カスタマイズが却下されると、システムは却下理由を記録してステータスを却下に変更すること
7. 承認されたカスタマイズが更新されると、システムは変更を防止して新しいカスタマイズを要求すること
8. カスタマイズが廃止になると、システムはステータスを廃止としてマークすること

### Req 12: OEM承認ワークフロー管理

**ユーザーストーリー:** 
OEM承認者として、カスタマイズ要求をレビュー・承認し、変更を適用する前に品質とコンプライアンスを確保したい。

**受け入れ基準:**
1. 承認が要求されると、システムはエンティティID、エンティティタイプ、OEMコード、要求者ID、要求日を記録すること
2. 承認タイプが指定されると、システムは承認タイプ（カスタマイズ、ロジック展開、信号変更）を保存すること
3. 承認理由が提供されると、システムは承認理由と関連データを保存すること
4. 承認が保留中の場合、システムは期限と優先度レベルの設定を許可すること
5. 承認が付与されると、システムは承認者ID、承認日、承認メモを記録すること
6. 承認が却下されると、システムは却下理由を記録してステータスを却下に変更すること
7. 承認がキャンセルされると、システムはキャンセル理由を記録してステータスをキャンセルに変更すること
8. 承認が期限切れの場合、システムは期限切れの承認を識別してフラグを立てること

### Req 13: 類似パターン検索

**ユーザーストーリー:** 
検出エンジニアとして、類似のCAN信号と検出パターンを検索し、既存の知識を再利用して検出ロジックを改善したい。

**受け入れ基準:**
1. 類似性検索が要求されると、システムは比較オプション付きの検索基準を受け入れること
2. 信号を比較する際、システムはCAN ID、信号名、システムタイプ、値範囲、データ長、サイクル時間、OEMコードに基づいて類似性を計算すること
3. 類似性が計算されると、システムは重み付けスコアによる詳細な類似性の内訳を提供すること
4. 類似信号が見つかると、システムは一致した属性と差異を識別すること
5. 推奨レベルが決定されると、システムは高推奨、高、中、低、非推奨として分類すること
6. 検索結果が返されると、システムは類似性スコアでソートして最大結果数に制限すること
7. テストデータが比較されると、システムは閾値の差異、条件の差異、結果の差異を分析すること
8. 比較推奨が生成されると、システムは優先度レベル付きの実行可能な推奨を提供すること

### Req 14: 異常分析サービス

**ユーザーストーリー:** 
テストエンジニアとして、異常検出パターンと精度を分析し、検出ロジックを最適化してシステムパフォーマンスを向上させたい。

**受け入れ基準:**
1. パターン分析が要求されると、システムは異常タイプ分布、レベル分布、頻度パターンを分析すること
2. 相関が分析されると、システムは信号間の異常の関係を識別すること
3. 検出精度が計算されると、システムは適合率、再現率、F1スコア、混同行列を計算すること
4. 閾値推奨が生成されると、システムは現在のパフォーマンスを分析して最適化を提案すること
5. パフォーマンスメトリクスが計算されると、システムは異常タイプと時間範囲ごとの精度を提供すること
6. 分析結果が返されると、システムは要約と実行可能な洞察を含めること

### Req 16: CAN仕様インポート機能

**ユーザーストーリー:** 
信号エンジニアとして、外部ファイル（CSV/DBC等）からCAN仕様を一括インポートし、手動入力の手間を削減したい。

**受け入れ基準:**
1. ファイルがアップロードされると、システムはファイル形式を検出すること（CSV、DBC等）
2. ファイルが解析されると、システムはメッセージIDとそれに含まれる信号の情報を抽出すること
3. 既存信号との照合が行われると、システムは一意のCAN ID（MessageId + SignalName）で既存データを検索すること
4. 既存信号が見つかった場合、システムは信号仕様と変換パラメータを更新すること（Upsert）
5. 新規信号の場合、システムは新しいCanSignalエンティティを作成すること
6. インポート完了後、システムはインポートされた信号のリストを返すこと

## 3. 非機能要件 (Non-Functional Requirements)

### NFR 1: パフォーマンス

**ユーザーストーリー:** 
システムユーザーとして、遅延なく効率的に作業できるよう、高速な応答時間を求める。

**受け入れ基準:**
1. ユーザーがCAN信号をクエリすると、システムは最大10,000レコードに対して500ミリ秒以内に結果を返すこと
2. 検出ロジックが実行されると、システムは標準的な複雑度の場合100ミリ秒以内に実行を完了すること
3. 類似性検索が実行されると、システムは最大1,000の候補信号に対して2秒以内に結果を返すこと
4. ダッシュボードが読み込まれると、システムは1秒以内に初期データを表示すること
5. 同時ユーザーがシステムにアクセスすると、システムはパフォーマンス低下なしに少なくとも100人の同時ユーザーをサポートすること

### NFR 2: セキュリティ

**ユーザーストーリー:** 
セキュリティ管理者として、機密性の高い自動車データを保護するため、堅牢なセキュリティ制御を求める。

**受け入れ基準:**
1. ユーザーが認証すると、システムはOAuth 2.0またはOpenID Connectプロトコルを使用すること
2. データが送信されると、システムはTLS 1.2以上の暗号化を使用すること
3. データが保存されると、システムはAES-256を使用して機密フィールドを暗号化すること
4. 認可がチェックされると、システムはロールベースアクセス制御（RBAC）を強制すること
5. 監査ログが作成されると、システムはユーザーIDとタイムスタンプですべてのデータ変更を記録すること
6. マルチテナント分離が強制されると、システムはクロステナントデータアクセスを防止すること

### NFR 3: スケーラビリティ

**ユーザーストーリー:** 
システム管理者として、増加するデータ量とユーザーベースに対応できるよう、システムのスケーラビリティを求める。

**受け入れ基準:**
1. データ量が増加すると、システムはテナントあたり少なくとも100万のCAN信号をサポートすること
2. 検出結果が蓄積されると、システムはテナントあたり少なくとも1000万の検出結果をサポートすること
3. テナントが追加されると、システムはアーキテクチャ変更なしに少なくとも50のテナントをサポートすること
4. データベースが成長すると、システムは2年以上経過したレコードのデータアーカイブを実装すること
5. 負荷が増加すると、システムはアプリケーションサーバーの水平スケーリングをサポートすること

### NFR 4: 可用性

**ユーザーストーリー:** 
ビジネス関係者として、ユーザーが必要なときにシステムにアクセスできるよう、高いシステム可用性を求める。

**受け入れ基準:**
1. システムが稼働している場合、システムは営業時間中99.5%の稼働時間を維持すること
2. 障害が発生すると、システムは重要なサービスに対して自動フェイルオーバーを実装すること
3. メンテナンスが必要な場合、システムはゼロダウンタイムデプロイメントをサポートすること
4. バックアップが実行されると、システムは30日間の保持期間で毎日バックアップを作成すること
5. 災害復旧が必要な場合、システムはRPO 1時間、RTO 4時間での復旧をサポートすること

### NFR 5: 保守性

**ユーザーストーリー:** 
開発者として、効率的にバグを修正して機能を追加できるよう、保守可能なコードを求める。

**受け入れ基準:**
1. コードが書かれると、システムはドメイン駆動設計（DDD）の原則に従うこと
2. コンポーネントが設計されると、システムはレイヤー間で明確な関心の分離を維持すること
3. テストが作成されると、システムはドメインロジックに対して少なくとも80%のコードカバレッジを達成すること
4. ドキュメントが提供されると、システムはOpenAPI/Swaggerを使用したAPIドキュメントを含めること
5. ロギングが実装されると、システムは相関IDを持つ構造化ロギングを使用すること
